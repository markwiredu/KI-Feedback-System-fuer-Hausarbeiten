<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WriteWise - KI-Feedback fÃ¼r Hausarbeiten</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> WriteWise</h1>
            <p>KI-Feedback fÃ¼r deine Hausarbeiten</p>
        </div>
        
        <div class="content">
            <!-- Eingabebereich -->
            <div class="input-section">
                <h2>Lass uns deine Hausarbeit analysieren!</h2>
                <form id="analysisForm">
                    <textarea 
                        id="textInput" 
                        placeholder="FÃ¼ge deine Hausarbeit hier ein... (Mindestens 50 Zeichen)"
                    ></textarea>

                    <!-- Datei-Upload Bereich -->
                    <div class="file-upload-section">
                        <h3>ğŸ“ Oder Datei hochladen</h3>
                        <input type="file" id="fileInput" accept=".txt,.pdf,.docx,.doc">
                        <small>UnterstÃ¼tzte Formate: TXT, PDF, DOCX (max. 16MB)</small>
                        <div id="fileInfo" class="file-info" style="display: none;">
                            ğŸ“„ <span id="fileName"></span> - <span id="fileSize"></span>
                        </div>
                    </div>
                    
                    <div class="char-count">
                        <span id="charCount">0</span> Zeichen
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button type="submit" class="btn" id="analyzeBtn">
                            ğŸ” Feedback generieren
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Ladeanimation -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analysiere deine Hausarbeit...</p>
            </div>
            
            <!-- Fehlermeldung -->
            <div class="error" id="error"></div>
            
            <!-- Ergebnisse -->
            <div class="results" id="results">
                <h2>ğŸ“ Feedback-Ergebnisse</h2>
                
                <div class="feedback-category">
                    <h3>ğŸ’¬ Sprachliches Feedback</h3>
                    <div id="languageFeedback"></div>
                </div>
                
                <div class="feedback-category">
                    <h3>ğŸ“Š Struktur und Aufbau</h3>
                    <div id="structureFeedback"></div>
                </div>
                
                <div class="feedback-category">
                    <h3>ğŸ¯ Argumentation</h3>
                    <div id="argumentationFeedback"></div>
                </div>
                
                <div class="feedback-category">
                    <h3>ğŸ“‹ Zusammenfassung</h3>
                    <div id="overallSummary"></div>
                </div>

                <!-- Export Bereich -->
                <div class="export-section">
             <h3>ğŸ“¥ Feedback exportieren</h3>
         <button class="btn export-btn" data-format="txt">ğŸ“ Als TXT</button>
               <button class="btn export-btn" data-format="pdf">ğŸ“„ Als PDF</button>
             </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" id="newAnalysisBtn">
                        ğŸ”„ Neue Analyse starten
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    // ZeichenzÃ¤hler
    document.getElementById('textInput').addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('charCount').textContent = count;
    });
    
    // Datei-Upload Handling
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileInfo = document.getElementById('fileInfo');
        
        if (file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            fileInfo.style.display = 'block';
            
            // Textarea leeren wenn Datei ausgewÃ¤hlt
            document.getElementById('textInput').value = '';
            document.getElementById('charCount').textContent = '0';
        } else {
            fileInfo.style.display = 'none';
        }
    });
    
    // Formular abschicken (ANGEPASST fÃ¼r Datei-Upload)
    document.getElementById('analysisForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        const textInput = document.getElementById('textInput').value.trim();
        const fileInput = document.getElementById('fileInput').files[0];
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        // PrÃ¼fen ob Text oder Datei vorhanden
        if (fileInput) {
            formData.append('file', fileInput);
        } else if (textInput) {
            formData.append('text', textInput);
        } else {
            showError('Bitte Text eingeben oder Datei hochladen');
            return;
        }
        
        // UI zurÃ¼cksetzen
        hideError();
        hideResults();
        showLoading(true);
        analyzeBtn.disabled = true;
        
        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                body: formData  // WICHTIG: Kein Content-Type Header bei FormData!
            });
            
            const data = await response.json();
            
            if (data.success) {
                displayFeedback(data);  
                showResults();
            } else {
                showError(data.error);
            }
            
        } catch (error) {
            showError('Netzwerkfehler: ' + error.message);
        } finally {
            showLoading(false);
            analyzeBtn.disabled = false;
        }
    });
    
    // Feedback anzeigen (ERWEITERT fÃ¼r Export)
    function displayFeedback(data) {
        const feedback = data.feedback;
        const kiVerwendet = data.ki_verwendet;
        
        // Sprachliches Feedback
        document.getElementById('languageFeedback').innerHTML = 
            feedback.language_feedback.map(item => 
                `<div class="feedback-item">â€¢ ${item}</div>`
            ).join('');
        
        // Struktur-Feedback
        document.getElementById('structureFeedback').innerHTML = 
            feedback.structure_feedback.map(item => 
                `<div class="feedback-item">â€¢ ${item}</div>`
            ).join('');
        
        // Argumentation
        document.getElementById('argumentationFeedback').innerHTML = 
            feedback.argumentation_feedback.map(item => 
                `<div class="feedback-item">â€¢ ${item}</div>`
            ).join('');
        
        // Zusammenfassung
        document.getElementById('overallSummary').textContent = 
            feedback.overall_summary;
        
        // KI-Status hinzufÃ¼gen
        const kiStatus = document.createElement('div');
        kiStatus.className = kiVerwendet ? 'success' : 'error';
        kiStatus.style.marginBottom = '20px';
        kiStatus.style.padding = '10px';
        kiStatus.style.borderRadius = '5px';
        kiStatus.textContent = kiVerwendet 
            ? 'âœ… Analyse mit KI durchgefÃ¼hrt' 
            : 'âš ï¸ Mock-Daten (KI in Entwicklung)';
        document.getElementById('results').prepend(kiStatus);
        
        // Datei-Info anzeigen falls verwendet
        if (data.file_used) {
            const fileInfo = document.createElement('div');
            fileInfo.className = 'success';
            fileInfo.style.marginBottom = '10px';
            fileInfo.textContent = 'âœ… Analyse aus hochgeladener Datei';
            document.getElementById('results').prepend(fileInfo);
        }
        
        // Export-Buttons aktivieren
        document.querySelectorAll('.export-btn').forEach(btn => {
            btn.dataset.resultid = data.result_id;
        });
    }
    
    // Export-FunktionalitÃ¤t
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('export-btn')) {
            const format = e.target.dataset.format;
            const resultId = e.target.dataset.resultid;
            
            if (!resultId) {
                showError('Kein Ergebnis zum Exportieren verfÃ¼gbar');
                return;
            }
            
            exportFeedback(resultId, format);
        }
    });
    
    function exportFeedback(resultId, format) {
        window.open(`/export/${format}/${resultId}`, '_blank');
    }
    
    // UI-Hilfsfunktionen
    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    
    function showResults() {
        document.getElementById('results').style.display = 'block';
    }
    
    function hideResults() {
        document.getElementById('results').style.display = 'none';
    }
    
    function showError(message) {
        document.getElementById('error').textContent = message;
        document.getElementById('error').style.display = 'block';
    }
    
    function hideError() {
        document.getElementById('error').style.display = 'none';
    }
    
    // Neue Analyse (ERWEITERT fÃ¼r Datei-Reset)
    document.getElementById('newAnalysisBtn').addEventListener('click', function() {
        document.getElementById('textInput').value = '';
        document.getElementById('charCount').textContent = '0';
        document.getElementById('fileInput').value = '';
        document.getElementById('fileInfo').style.display = 'none';
        hideResults();
        hideError();
    });
    
    // Initialisierung
    console.log('WriteWise Frontend mit Datei-Upload geladen');
</script>
</body>
</html>